name: APK AzurLane JMBQ Build Work (Bilibili)
on:
  workflow_dispatch:
    inputs:
      server_name:
        description: '区服名称-必须（Bilibili服直接用默认值）'
        required: true
        type: string
        default: 'Bilibili'  # Bilibili服默认值
      download_url:
        description: 'Bilibili服APK直链（已替换为有效直链）'
        required: true
        type: string
        default: 'https://pkg.biligame.com/games/blhx_9.6.12_1017_2_20251107_030822_40c3c.apk'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y p7zip-full wget aria2

      - name: Setup Java JDK
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install build-tools
        run: |
          # Accepts licenses and installs build-tools (adjust version if needed)
          yes | sdkmanager --install "build-tools;35.0.0"

      - name: Create Bilibili merge_build.sh
        run: |
          cat > merge_build.sh << 'EOF'
          #!/bin/bash
          # Bilibili服碧蓝航线APK构建脚本
          set -euo pipefail

          SERVER_NAME="$1"
          DOWNLOAD_URL="$2"

          # ========== 版本号与直链中的9.6.12匹配 ==========
          VERSION="9.6.12"
          JMBQ_VERSION="${VERSION}_${SERVER_NAME}"

          # 输出环境变量（供Release使用）
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "JMBQ_VERSION=${JMBQ_VERSION}" >> "$GITHUB_ENV"

          TMP_DIR="apk_temp"
          mkdir -p "${TMP_DIR}"
          cd "${TMP_DIR}"

          OUT_APK_NAME="${SERVER_NAME}_AzurLane.apk"
          echo "开始下载Bilibili服APK: ${DOWNLOAD_URL}"
          # Use retries and timeout; avoid --allow-insecure-certificate unless necessary
          aria2c -x 16 -s 16 --retry-wait=5 --max-tries=5 --timeout=60 -o "${OUT_APK_NAME}" "${DOWNLOAD_URL}"

          # Optional: verify checksum here (recommended)
          # echo "expected_checksum  ${OUT_APK_NAME}" | sha256sum -c -

          echo "分卷打包Bilibili服APK..."
          7z a -v1G "${SERVER_NAME}-V.${VERSION}.7z" "${OUT_APK_NAME}"

          # Move split files to repository root robustly
          mv -f "${SERVER_NAME}-V.${VERSION}.7z."* ../ || true

          cd .. && rm -rf "${TMP_DIR}"
          echo "Bilibili服APK打包完成！"
          EOF

          chmod +x merge_build.sh

      - name: Build Bilibili APK
        run: |
          ./merge_build.sh "${{ github.event.inputs.server_name }}" "${{ github.event.inputs.download_url }}"

      - name: Release Bilibili APK
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ env.JMBQ_VERSION }}-APK"
          name: "AzurLane JMBQ ${{ env.JMBQ_VERSION }} (Bilibili) Build APK"
          artifacts: "${{ github.event.inputs.server_name }}-V.${{ env.VERSION }}.7z.*"
          allowUpdates: true
          token: ${{ github.token }}
          body: |
            <details>
              <summary>中文安装说明 - Bilibili服（点击展开）</summary>
                1. 下载下方所有Bilibili-V.9.6.12.7z.00* 结尾的文件</br>
                2. 解压时选择"Bilibili-V.9.6.12.7z.001"即可自动合并所有分卷</br>
                3. 解压后安装APK（手机需开启未知来源安装）
            </details>

            <details>
              <summary>English Instructions - Bilibili Server (Click to expand)</summary>
                1. Download all files ending with Bilibili-V.9.6.12.7z.00*</br>
                2. Extract "Bilibili-V.9.6.12.7z.001" to merge all split files automatically</br>
                3. Install the APK after extraction (enable unknown source installation on your phone)
            </details>
